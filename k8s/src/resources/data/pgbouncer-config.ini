[databases]
# Map logical database names to PostgreSQL backend
# * = fallback rule for any database not explicitly listed
# Using postgres-direct service for actual PostgreSQL connection
grafana = host=postgres-direct port=5432 dbname=grafana
keycloak = host=postgres-direct port=5432 dbname=keycloak
shlink = host=postgres-direct port=5432 dbname=shlink
* = host=postgres-direct port=5432

[pgbouncer]
# Session pooling mode - fully compatible with all PostgreSQL features
# Connection is assigned to client until client disconnects
pool_mode = session

# Listen on all interfaces within the pod
listen_addr = 0.0.0.0
listen_port = 5432

# Authentication
# Using md5 for simpler password handling (hashes are generated from plain passwords)
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# Ignore client parameters that PgBouncer doesn't support
# This allows PostgreSQL clients to connect without errors
ignore_startup_parameters = extra_float_digits,options

# Connection limits
# Max client connections (total across all databases)
max_client_conn = 100

# Default pool size per database (how many server connections to maintain)
default_pool_size = 10

# Min pool size per database (keep warm connections)
min_pool_size = 2

# Reserve pool - extra connections for emergencies
reserve_pool_size = 5

# How many additional connections to allow to db during "max_db_connections" surge
reserve_pool_timeout = 3

# Maximum connections per database
max_db_connections = 20

# Maximum connections per user per database
max_user_connections = 20

# Logging
# Log connections/disconnections (useful for debugging)
log_connections = 1
log_disconnections = 1

# Log pooler errors and warnings
log_pooler_errors = 1

# Verbose level (0 = off, 1 = normal, 2 = verbose)
verbose = 0

# Server lifetime and cleanup
# Close server connection after this time (1 hour)
server_lifetime = 3600

# Check for idle server connections to close (10 seconds)
server_idle_timeout = 600

# Query timeout - close client connection if query takes longer (5 minutes)
query_timeout = 300

# Client idle timeout - disconnect idle clients (10 minutes)
client_idle_timeout = 600

# DNS settings
dns_max_ttl = 15
dns_zone_check_period = 0

# Performance tuning
# Disable TCP_NODELAY to reduce overhead for small packets
tcp_keepalive = 1
tcp_keepcnt = 5
tcp_keepidle = 30
tcp_keepintvl = 10

# Stats monitoring
stats_period = 60

# Admin interface
admin_users = postgres
